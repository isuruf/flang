environment:
  CONDA_INSTALL_LOCN: C:\\Miniconda36-x64

branches:
  only:
    - master
    - windows

platform:
  - x64

install:
  # Add path, activate `conda` and update conda.
  - cmd: call %CONDA_INSTALL_LOCN%\Scripts\activate.bat
  - cmd: conda update --yes --quiet conda
  # Add our channels.
  - cmd: conda config --add channels defaults
  - cmd: conda config --add channels conda-forge
  - cmd: conda config --add channels isuruf/label/flang
  - cmd: conda install --yes --quiet clangdev openmp cmake
  - ps: pip install lit


build_script:
  - mkdir build
  - cd build
  - set "PATH=%cd%\bin;%PATH%"
  - call "C:\Program Files (x86)\Microsoft Visual Studio 14.0\VC\vcvarsall.bat" amd64
  - ps: |
      cmake -G "NMake Makefiles" -DFLANG_INCLUDE_TESTS=ON -DCMAKE_C_COMPILER=clang-cl -DCMAKE_CXX_COMPILER=clang-cl -DCMAKE_Fortran_COMPILER=flang -DCMAKE_VERBOSE_MAKEFILE=ON -DCMAKE_BUILD_TYPE=Release ..
      Push-AppveyorArtifact .\CMakeFiles\CMakeOutput.log
      Push-AppveyorArtifact .\CMakeFiles\CMakeError.log
  - ps: |
      cmake --build . 2>&1 | Out-File build_output.txt
      if($LastExitCode -ne 0) { $host.SetShouldExit($LastExitCode )  }
      Push-AppveyorArtifact .\build_output.txt
      Get-Content .\build_output.txt -Tail 500
      nmake check-flang
  - ps: Compress-Archive -Path C:\projects\flang\build\bin -DestinationPath C:\Projects\flang\bin.zip
  - ps: Push-AppveyorArtifact C:\Projects\flang\bin.zip
  - ps: Compress-Archive -Path C:\projects\flang\build\lib -DestinationPath C:\Projects\flang\lib.zip
  - ps: Push-AppveyorArtifact C:\Projects\flang\lib.zip
  
